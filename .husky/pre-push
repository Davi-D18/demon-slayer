#!/bin/bash

# Verifica se o bash estÃ¡ sendo usado
if [ -z "$BASH_VERSION" ]; then
    exec bash "$0" "$@"
fi

set -e

# FunÃ§Ã£o para exibir um spinner enquanto o processo estÃ¡ rodando
spinner() {
    local pid=$1
    local message=$2
    local delay=0.1
    local spinstr=("â ‹" "â ™" "â ¹" "â ¸" "â ¼" "â ´" "â ¦" "â §" "â ‡" "â ")
    local i=0
    tput civis # Esconde o cursor
    while ps -p $pid >/dev/null; do
        printf "\r%s %s" "$message" "${spinstr[i]}"
        i=$(((i + 1) % ${#spinstr[@]}))
        sleep $delay
    done
    tput cnorm # Mostra o cursor
    echo -ne "\r$message âœ…\n"
}

# FunÃ§Ã£o para exibir a seÃ§Ã£o de mensagens principais de forma mais organizada e centralizada
show_message() {
    clear
    local msg1="$1"
    local msg2="$2"
    local len=${#msg1}
    local width=50 # Largura do terminal para centralizar

    # Adiciona espaÃ§amento Ã  esquerda e direita para centralizar
    local padding=$(((width - len) / 2))
    local spaces=$(printf "%-${padding}s" " ")

    echo "========================================================"
    echo -e "${spaces}\033[1;34m$msg1\033[0m" # TÃ­tulo em azul, centralizado
    echo "--------------------------------------------------------"
    echo -e "${spaces}\033[1;32m$msg2\033[0m" # AÃ§Ã£o em verde, centralizado
    echo "========================================================"
    echo ""
}

# FunÃ§Ã£o para finalizar o processo do Vite
kill_vite_process() {
    echo "ğŸš« Finalizando o processo do Vite..."
    sleep 1.2
    if [[ -n "$VITE_PID" ]]; then
        pkill -f "vite preview" 2>/dev/null && echo "âœ… Vite finalizado."
    else
        echo "â„¹ï¸ Nenhum processo do Vite em execuÃ§Ã£o."
    fi
}

# Verifica se o Vite jÃ¡ estÃ¡ rodando na porta 4173
check_vite_running() {
    if nc -z localhost 4173 >/dev/null 2>&1; then
        VITE_PID=$(lsof -t -i :4173)
    else
        VITE_PID=""
    fi
}

# Exibe mensagem inicial
show_message "InÃ­cio do script: ConfiguraÃ§Ã£o do Vite" "ğŸ”§ Preparando ambiente"
sleep 1.6

# Realiza o build do Vite
show_message "Etapa 1: Build do Vite" "ğŸ” Iniciando o build..."
npx vite build --mode production &>/dev/null &
build_pid=$!
spinner $build_pid "ğŸ”„ Realizando o build"

wait $build_pid
if [[ $? -ne 0 ]]; then
    echo "âŒ ERRO: Falha no build.\nDica: Verifique a saÃ­da de 'npx vite build' para mais detalhes." >&2
    exit 1
fi

sleep 1.8

# Verifica se o servidor de preview jÃ¡ estÃ¡ rodando
show_message "Etapa 2: VerificaÃ§Ã£o do servidor de preview" "ğŸ”„ Aguardando servidor iniciar..."
check_vite_running

if [[ -z "$VITE_PID" ]]; then
    npx vite preview --mode production &>/dev/null &
    VITE_PID=$!
    echo -n "ğŸ”„ Aguardando o servidor iniciar..."

    i=1
    while [ $i -le 10 ]; do
        if nc -z localhost 4173 >/dev/null 2>&1; then
            echo ""
            echo "âœ… Servidor iniciado."
            sleep 1.5
            break
        fi

        echo "($i/10)"
        sleep 2
        i=$((i + 1))
    done

    if ! nc -z localhost 4173 >/dev/null 2>&1; then
        echo "âŒ ERRO: Falha ao iniciar o servidor."
        kill_vite_process
        exit 1
    fi
else
    echo "âœ… Servidor jÃ¡ rodando na porta 4173."
    sleep 1.5
fi

# Testa a pÃ¡gina
show_message "Etapa 3: VerificaÃ§Ã£o da pÃ¡gina" "ğŸ” Validando pÃ¡gina..."
if ! node validatePage.cjs; then
    echo ""
    echo "âŒ ERRO: Falha na validaÃ§Ã£o da pÃ¡gina. Confira o arquivo 'validation_report.txt' para mais detalhes."
    kill_vite_process
    exit 1
else
    echo "âœ… PÃ¡gina validada com sucesso."
fi

sleep 4

# Finaliza o servidor
show_message "Etapa 4: Finalizando o servidor" "âš™ï¸ Finalizando processo..."
kill_vite_process
sleep 1.3

# ConclusÃ£o
show_message "Script concluÃ­do com sucesso!" "ğŸš€ Push serÃ¡ executado!"
sleep 1.3
exit 0
